# speak2type Phase 1 Implementation

**Date**: 2026-01-26

## Completed

### Phase 0: Project Setup
- [x] Git repository initialized
- [x] `.gitignore` created
- [x] `policy-exceptions.md` created with model download defaults
- [x] Upstream IBus-Speech-To-Text cloned into `src/upstream/`
- [x] `UPSTREAM.md` documenting commit hash `323d909ec62c2568dd562f97c8a897bb5b06a81c`
- [x] `.aisteering/` templates filled (PRODUCT, TECHNOLOGY, ARCHITECTURE)
- [x] `pyproject.toml` created with dependencies
- [x] `scripts/dev-install.sh` created for Ubuntu setup
- [x] `README.md` created

### Phase 1: Push-to-Talk Mode
- [x] Core types defined (`src/speak2type/types.py`)
  - `EngineState` enum (IDLE, RECORDING, TRANSCRIBING, COMMITTING)
  - `RecordMode` enum (TOGGLE, PUSH_TO_TALK)
  - `AudioSource` enum (AUTO, PIPEWIRE, PULSEAUDIO)
  - `AudioFormat`, `AudioSegment` dataclasses
  - `TranscriptResult`, `Segment` dataclasses
  - `Backend` protocol

- [x] Audio capture implemented (`src/speak2type/audio_capture.py`)
  - GStreamer pipeline with pipewiresrc/pulsesrc
  - Runtime detection of best audio source
  - Optional webrtcdsp noise suppression
  - Buffer management for push-to-talk

- [x] Worker thread implemented (`src/speak2type/worker.py`)
  - Background thread for transcription
  - Job queue with thread-safe submission
  - `GLib.idle_add()` for main loop callbacks

- [x] Engine implemented (`src/speak2type/engine.py`)
  - `Speak2TypeEngine` IBus engine class
  - State machine with transitions
  - Alt+Space push-to-talk key handling
  - `RELEASE_MASK` for press/release detection
  - Privacy: `do_set_content_type()` for PASSWORD/PIN detection
  - Properties for IBus panel

- [x] GSettings schema updated
  - Added `record-mode` (toggle/push_to_talk)
  - Added `ptt-hotkey` (default: `<Alt>space`)
  - Added `audio-source` (auto/pipewire/pulseaudio)

- [x] Backend registry (`src/speak2type/backends/base.py`)
  - `BackendRegistry` class
  - `PlaceholderBackend` for testing
  - Global registry singleton

- [x] Test suite started
  - `tests/test_types.py` - type tests
  - `tests/test_backends.py` - backend registry tests

## Files Created

```
speak2type/
├── .gitignore
├── AUTHORS
├── COPYING
├── Changelog
├── README.md
├── UPSTREAM.md
├── policy-exceptions.md
├── pyproject.toml
├── data/
│   └── org.freedesktop.ibus.engine.stt.gschema.xml.in (updated)
├── scripts/
│   └── dev-install.sh
├── src/
│   ├── speak2type/
│   │   ├── __init__.py
│   │   ├── types.py
│   │   ├── audio_capture.py
│   │   ├── worker.py
│   │   ├── engine.py
│   │   ├── backends/
│   │   │   ├── __init__.py
│   │   │   └── base.py
│   │   └── model_managers/
│   │       └── __init__.py
│   └── upstream/
│       └── (upstream code preserved)
└── tests/
    ├── __init__.py
    ├── conftest.py
    ├── test_types.py
    └── test_backends.py
```

## Phase 2: Backend Interface (Completed)

- [x] Create Vosk backend adapter (`src/speak2type/backends/vosk_adapter.py`)
  - Uses vosk Python library directly for batch transcription
  - Supports word-level timing
  - Auto-finds models in XDG directories
- [x] Create Whisper backend adapter (`src/speak2type/backends/whisper_adapter.py`)
  - Uses pywhispercpp for whisper.cpp transcription
  - Filters out non-speech segments like [music]
  - Configurable language and thread count
- [x] Integrate backends with engine
  - Backend registry initialized on engine startup
  - Worker thread uses backend for transcription
  - Settings-based backend selection
- [x] Add backend tests

## Next Steps (Phase 3)

1. Create Parakeet ONNX backend using `onnx-asr`
2. Implement model download/management
3. Create benchmark harness

## Notes

- Upstream code is in `src/upstream/` to preserve original structure
- New speak2type code is in `src/speak2type/`
- Backend adapters use Python libraries directly (not wrapping GStreamer pipelines)
- Worker thread ensures IBus main loop is never blocked
- Privacy check is implemented but needs testing with real password fields
