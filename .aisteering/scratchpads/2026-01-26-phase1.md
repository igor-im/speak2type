# speak2type Implementation Summary

**Date**: 2026-01-26

## Completed Phases

### Phase 0: Project Setup
- [x] Git repository initialized
- [x] `.gitignore` created
- [x] `policy-exceptions.md` created with model download defaults
- [x] Upstream IBus-Speech-To-Text cloned into `src/upstream/`
- [x] `UPSTREAM.md` documenting commit hash `323d909ec62c2568dd562f97c8a897bb5b06a81c`
- [x] `.aisteering/` templates filled (PRODUCT, TECHNOLOGY, ARCHITECTURE)
- [x] `pyproject.toml` created with dependencies
- [x] `scripts/dev-install.sh` created for Ubuntu setup
- [x] `README.md` created

### Phase 1: Push-to-Talk Mode
- [x] Core types (`src/speak2type/types.py`)
- [x] Audio capture (`src/speak2type/audio_capture.py`)
- [x] Worker thread (`src/speak2type/worker.py`)
- [x] Engine with push-to-talk (`src/speak2type/engine.py`)
- [x] Privacy check for PASSWORD/PIN fields
- [x] GSettings schema with PTT settings

### Phase 2: Backend Interface
- [x] Vosk backend adapter (`src/speak2type/backends/vosk_adapter.py`)
- [x] Whisper backend adapter (`src/speak2type/backends/whisper_adapter.py`)
- [x] Backend registry integration with engine

### Phase 3: Parakeet ONNX Backend
- [x] Parakeet backend adapter (`src/speak2type/backends/parakeet_adapter.py`)
- [x] Model manager (`src/speak2type/model_managers/parakeet.py`)
- [x] Benchmark harness (`scripts/benchmark.py`)

### Phase 4: HTTP Backend
- [x] HTTP backend adapter (`src/speak2type/backends/http_adapter.py`)
- [x] Reference FastAPI server (`server/main.py`)
- [x] OpenAPI schema (`server/openapi.yaml`)

## Git Commits

1. `e86c8e5` - Initial implementation of speak2type (Phase 0-1)
2. `a3f1eae` - Add Vosk and Whisper backend adapters (Phase 2)
3. `fd6cb13` - Add Parakeet ONNX backend and benchmark harness (Phase 3)
4. `2d4d599` - Add HTTP backend and reference server (Phase 4)

## Project Structure

```
speak2type/
├── .aisteering/           # Project steering docs
├── .gitignore
├── AUTHORS
├── COPYING               # GPL-3.0 license
├── Changelog
├── README.md
├── UPSTREAM.md           # Upstream documentation
├── policy-exceptions.md  # Policy exception for model defaults
├── pyproject.toml        # Python packaging
├── data/                 # GSettings schema, formatting files
├── scripts/
│   ├── dev-install.sh    # Development installation
│   └── benchmark.py      # Performance benchmarks
├── server/
│   ├── main.py           # Reference HTTP server
│   └── openapi.yaml      # API schema
├── src/
│   ├── speak2type/       # Main package
│   │   ├── __init__.py
│   │   ├── types.py      # Core types
│   │   ├── audio_capture.py
│   │   ├── worker.py     # Transcription worker
│   │   ├── engine.py     # IBus engine
│   │   ├── backends/
│   │   │   ├── __init__.py
│   │   │   ├── base.py           # Registry
│   │   │   ├── vosk_adapter.py
│   │   │   ├── whisper_adapter.py
│   │   │   ├── parakeet_adapter.py
│   │   │   └── http_adapter.py
│   │   └── model_managers/
│   │       ├── __init__.py
│   │       └── parakeet.py
│   └── upstream/         # Upstream code preserved
└── tests/
    ├── conftest.py
    ├── test_types.py
    └── test_backends.py
```

## Key Features Implemented

1. **Push-to-Talk**: Alt+Space to record, release to transcribe
2. **Multiple Backends**: Vosk, Whisper, Parakeet, HTTP
3. **Privacy Protection**: Disabled in password fields
4. **Non-blocking**: Worker thread for transcription
5. **XDG Compliance**: Standard Linux directories
6. **Benchmark Harness**: RTF, latency, memory measurement

## IBus Integration Debugging (2026-01-26)

### Issue
Engine process started but IBus couldn't find factory at `/org/freedesktop/IBus/Factory`.

### Root Cause
The factory must be created and registered **before** calling `bus.request_name()`. The wrong order was:
```python
bus.request_name(...)  # WRONG: called first
factory = Factory(bus)  # Factory created after
```

### Fix
```python
factory = Factory(bus)  # Create factory FIRST
factory.add_engine(...)  # Register engine type
bus.request_name(...)   # THEN request name (only in IBus mode)
```

### Other Fixes Applied
- Added `--ibus` flag to component XML exec path
- Added `GSETTINGS_SCHEMA_DIR` to engine launcher script
- Fixed `pyproject.toml` package path (`where = ["src"]`)

### Verification
```bash
export IBUS_COMPONENT_PATH="$HOME/.local/share/ibus/component:/usr/share/ibus/component"
ibus write-cache && ibus restart && sleep 2 && ibus engine speak2type
# Exit code 0 = success
```

## Parakeet Backend Integration (2026-01-26)

### Issue
The original onnx-asr API used `ONNXModel` class which no longer exists.

### Fix
1. Updated to new onnx-asr API using `onnx_asr.load_model()`
2. Changed transcription to use `model.recognize()` method
3. Installed `huggingface_hub` dependency for model downloads
4. Changed default model to `nemo-parakeet-tdt-0.6b-v3` (multilingual)

### Key Changes
```python
# Old API (broken):
from onnx_asr import ONNXModel
model = ONNXModel(model_name)
result = model(audio)

# New API (working):
import onnx_asr
model = onnx_asr.load_model(model_name)
result = model.recognize(audio, sample_rate=16000)  # returns str
```

### Testing
```bash
# The engine now uses Parakeet for real speech recognition
# In gnome-text-editor:
# 1. Press Option+Space
# 2. Speak
# 3. Release Option+Space
# -> Actual transcribed text appears
```

## Next Steps (Future Work)

### Phase 5: Always-On Mode
- [ ] Segmenter interface
- [ ] VAD segmenter (Silero)
- [ ] Status icon / mic indicator
- [ ] Quick mute toggle

### Beyond
- [ ] GNOME Shell extension for global hotkey
- [ ] Custom voice commands
- [ ] Packaging for Fedora/Ubuntu
